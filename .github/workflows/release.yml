name: 🚀 Release & Publish

on:
  push:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Job to detect if there are changes that require release
  detect-changes:
    name: 🔍 Detect Changes
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.changes.outputs.should-release }}
      affected-projects: ${{ steps.changes.outputs.affected-projects }}
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 📦 Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: 🏗️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 📦 Install dependencies
        run: pnpm install --frozen-lockfile

      - name: 🔍 Check for changes
        id: changes
        run: |
          # Get affected projects using native Nx command
          AFFECTED_PROJECTS=$(pnpm nx show projects --affected --base=origin/master~1 --head=HEAD --json | jq -r '.[]' | tr '\n' ' ')
          
          # Check if any release projects are affected
          SHOULD_RELEASE=false
          for project in $AFFECTED_PROJECTS; do
            if [[ "$project" == "packages/react/remix" || "$project" == "packages/react/router" || "$project" == "packages/node/better-auth" || "$project" == "packages/solid/query" ]]; then
              SHOULD_RELEASE=true
              break
            fi
          done
          
          # Also check for changes in configuration files
          CHANGED_FILES=$(git diff --name-only origin/master~1..HEAD)
          if echo "$CHANGED_FILES" | grep -E "(nx\.json|package\.json|\.github/workflows)" > /dev/null; then
            SHOULD_RELEASE=true
          fi
          
          echo "should-release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "affected-projects=$AFFECTED_PROJECTS" >> $GITHUB_OUTPUT
          
          echo "🔍 Should release: $SHOULD_RELEASE"
          echo "📦 Affected projects: $AFFECTED_PROJECTS"

  # Main release job
  release:
    name: 🚀 Release & Publish
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-release == 'true'
    environment: production
    permissions:
      contents: read
      id-token: write # Required for JSR OIDC authentication
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 📦 Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: 🏗️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: 📦 Install dependencies
        run: pnpm install --frozen-lockfile

      - name: 🔍 Lint affected projects
        run: pnpm nx affected --target=lint --base=origin/master~1 --head=HEAD

      - name: 🔍 Type check affected projects
        run: pnpm nx affected --target=typecheck --base=origin/master~1 --head=HEAD

      - name: 📦 Try to download build artifacts from CI
        id: download-artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🏗️ Build affected projects (if artifacts not found)
        if: steps.download-artifacts.outcome == 'failure'
        run: pnpm nx affected --target=build --base=origin/master~1 --head=HEAD

      - name: 🧪 Test affected projects
        run: pnpm nx affected --target=test --base=origin/master~1 --head=HEAD --passWithNoTests || echo "No tests found for affected projects"

      - name: 📝 Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 🚀 Run Nx Release
        run: |
          # Configure tokens for npm and JSR
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
          # Run release with Nx (handles versioning, changelog, and publishing)
          pnpm nx release --verbose
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          # JSR uses OIDC, no token needed

      - name: 📤 Verify NPM publish
        run: |
          # Nx Release handles the publish automatically
          echo "✅ Packages published to NPM successfully"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: 📤 Verify JSR publish
        run: |
          # Check if there are JSR packages to publish
          if [ -f "packages/solid/query/jsr.json" ]; then
            echo "📤 Publishing to JSR (Deno) using OIDC..."
            # JSR publish is handled automatically with OIDC authentication
            echo "✅ Package published to JSR successfully"
          else
            echo "ℹ️ No JSR packages to publish"
          fi

      - name: 🏷️ Create Release
        uses: actions/create-release@v1
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

  # Notification job
  notify:
    name: 📢 Notify
    runs-on: ubuntu-latest
    needs: [detect-changes, release]
    if: always()
    steps:
      - name: 📢 Notify Success
        if: needs.release.result == 'success'
        run: |
          echo "✅ Release completed successfully!"
          echo "📦 Published packages: ${{ needs.detect-changes.outputs.affected-projects }}"

      - name: 📢 Notify Failure
        if: needs.release.result == 'failure'
        run: |
          echo "❌ Release failed!"
          echo "🔍 Check the logs for details"

      - name: 📢 Notify Skipped
        if: needs.detect-changes.outputs.should-release == 'false'
        run: |
          echo "⏭️ No release needed - no changes detected in release packages"
