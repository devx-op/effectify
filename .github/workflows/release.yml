name: ğŸš€ Release & Publish

on:
  push:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Job to detect if there are changes that require release
  detect-changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.changes.outputs.should-release }}
      affected-projects: ${{ steps.changes.outputs.affected-projects }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Check for changes
        id: changes
        run: |
          # Get affected projects using native Nx command with proper base detection
          BASE=$(git merge-base HEAD origin/master)
          AFFECTED_PROJECTS=$(pnpm nx show projects --affected --base=$BASE --head=HEAD --json | jq -r '.[]' | tr '\n' ' ')
          
          # Nx release will handle which projects to release based on nx.json configuration
          # We just need to check if there are any affected projects
          SHOULD_RELEASE=false
          if [ -n "$AFFECTED_PROJECTS" ]; then
            SHOULD_RELEASE=true
          fi
          
          echo "should-release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "affected-projects=$AFFECTED_PROJECTS" >> $GITHUB_OUTPUT
          
          echo "ğŸ” Should release: $SHOULD_RELEASE"
          echo "ğŸ“¦ Affected projects: $AFFECTED_PROJECTS"

  # Main release job
  release:
    name: ğŸš€ Release & Publish
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-release == 'true'
    environment: production
    permissions:
      contents: read
      id-token: write # Required for JSR OIDC authentication
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Type check affected projects
        run: |
          BASE=$(git merge-base HEAD origin/master)
          pnpm nx affected --target=typecheck --base=$BASE --head=HEAD

      - name: ğŸ“¦ Try to download build artifacts from CI
        id: download-artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build affected projects (if artifacts not found)
        if: steps.download-artifacts.outcome == 'failure'
        run: |
          BASE=$(git merge-base HEAD origin/master)
          pnpm nx affected --target=build --base=$BASE --head=HEAD

      - name: ğŸ§ª Test affected projects
        run: |
          BASE=$(git merge-base HEAD origin/master)
          pnpm nx affected --target=test --base=$BASE --head=HEAD --passWithNoTests || echo "No tests found for affected projects"

      - name: ğŸ“ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸš€ Run Nx Release
        run: |
          # Configure tokens for npm and JSR
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
          # Run release with Nx (handles versioning, changelog, and publishing)
          pnpm nx release --verbose
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          # JSR uses OIDC, no token needed

      - name: ğŸ“¤ Verify NPM publish
        run: |
          # Nx Release handles the publish automatically
          echo "âœ… Packages published to NPM successfully"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ“¤ Verify JSR publish
        run: |
          # Check if there are JSR packages to publish
          if [ -f "packages/solid/query/jsr.json" ]; then
            echo "ğŸ“¤ Publishing to JSR (Deno) using OIDC..."
            # JSR publish is handled automatically with OIDC authentication
            echo "âœ… Package published to JSR successfully"
          else
            echo "â„¹ï¸ No JSR packages to publish"
          fi

      - name: ğŸ·ï¸ Create Release
        uses: actions/create-release@v1
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

  # Notification job
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [detect-changes, release]
    if: always()
    steps:
      - name: ğŸ“¢ Notify Success
        if: needs.release.result == 'success'
        run: |
          echo "âœ… Release completed successfully!"
          echo "ğŸ“¦ Published packages: ${{ needs.detect-changes.outputs.affected-projects }}"

      - name: ğŸ“¢ Notify Failure
        if: needs.release.result == 'failure'
        run: |
          echo "âŒ Release failed!"
          echo "ğŸ” Check the logs for details"

      - name: ğŸ“¢ Notify Skipped
        if: needs.detect-changes.outputs.should-release == 'false'
        run: |
          echo "â­ï¸ No release needed - no changes detected in release packages"
